name: build

on:
  pull_request:
    branches:
      - "*"
  push:
    branches:
      - "main"
    tags:
      - "*"
  workflow_dispatch: {}

jobs:
  rust-build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          components: rust-src, clippy, rustfmt
          override: false
      - name: Install bpf-linker
        run: |
          cargo install bpf-linker
      - name: Build all rust crates (dataplane, test server)
        run: |
          make build
      - name: Check formatting
        run: |
          make check.format
      - name: Check clippy
        run: |
          make lint
      - name: Run Tests
        run: |
          make test

  image-builds-integration-tests:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.1.7
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            sources:
              - Cargo.lock
              - Cargo.toml
              - 'controlplane/**'
              - 'dataplane/**'
              - 'build/Containerfile.*'
      - name: Build controlplane Container Image
        if: steps.filter.outputs.sources
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          push: false
          context: .
          file: build/Containerfile.controlplane
          tags: localhost/blixt-controlplane:pr-${{ github.event.pull_request.number }}-${{ github.sha }}
      - name: Build dataplane Container Image
        if: steps.filter.outputs.sources
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          push: false
          context: .
          file: build/Containerfile.dataplane
          tags: localhost/blixt-dataplane:pr-${{ github.event.pull_request.number }}-${{ github.sha }}
      - name: Build udp-test-server Container Image
        if: steps.filter.outputs.sources
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          push: false
          context: .
          file: build/Containerfile.udp-test-server
          tags: localhost/blixt-udp-test-server:pr-${{ github.event.pull_request.number }}-${{ github.sha }}
      - name: Install kind and kubectl
        uses: helm/kind-action@b72c923563e6e80ea66e8e8c810798cc73e97e5e # current main, includes cloud-provider-kind support
        if: steps.filter.outputs.sources
        with:
          install_only: true
          cloud_provider: false
          kubectl_version: 'v1.33.3'
      - name: Install Rust
        if: steps.filter.outputs.sources
        uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # v1
        with:
          toolchain: stable
      - name: Run Integration Tests
        if: steps.filter.outputs.sources
        run: |
          export REGISTRY="localhost"
          export TAG="pr-${{ github.event.pull_request.number }}-${{ github.sha }}"
          make test.integration